---
/**
 * Tag Page - Posts filtered by tag
 */

import Layout from "../../layouts/Layout.astro";
import PageHeader from "../../components/PageHeader.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import PostCard from "../../components/PostCard.astro";
import "../../styles/home.css";
import "../../styles/tags.css";

interface Props {
  posts: CollectionEntry<"blog">[];
}

export async function getStaticPaths() {
  const posts = await getCollection("blog", ({ data }) => !data.isDraft);
  const uniqueTags = [...new Set(posts.flatMap((post) => post.data.tags))];

  return uniqueTags.map((tag) => {
    const filteredPosts = posts
      .filter((post) => post.data.tags.includes(tag))
      .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

    return {
      params: { tag },
      props: { posts: filteredPosts },
    };
  });
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<Layout title={`#${tag} | fpl0`} description={`Posts tagged with #${tag}`}>
  <PageHeader backLink="/tags" backText="â† all tags" />

  <main id="main-content" class="page-main">
    <header class="page-header">
      <h1>#{tag}</h1>
    </header>
    <p class="tag-subtitle" style="margin-bottom: 2rem;">
      {posts.length}
      {posts.length === 1 ? "post" : "posts"} tagged with #{tag}
    </p>

    <section class="archive">
      <ul class="post-list">
        {posts.map((post) => <PostCard post={post} />)}
      </ul>
    </section>
  </main>
</Layout>
