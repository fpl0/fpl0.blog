---
/**
 * fractal-explorer -- App Component
 *
 * Interactive Mandelbrot / Julia set explorer rendered on an HTML5 Canvas.
 * Self-contained UI and all client-side logic.
 * Auto-discovered by the dynamic route at src/pages/apps/[slug].astro.
 */
---

<div class="fractal-root" id="fractal-root">
	<canvas class="fractal-canvas" id="fractal-canvas"></canvas>

	<div class="fractal-controls" id="fractal-controls">
		<div class="fractal-controls-row">
			<div class="fractal-group">
				<button
					class="fractal-btn fractal-btn--active"
					id="fractal-btn-mandelbrot"
					type="button"
					aria-pressed="true"
				>Mandelbrot</button>
				<button
					class="fractal-btn"
					id="fractal-btn-julia"
					type="button"
					aria-pressed="false"
				>Julia</button>
				<button
					class="fractal-btn"
					id="fractal-btn-zoom"
					type="button"
					aria-pressed="false"
					aria-label="Infinite auto-zoom"
				>Zoom</button>
			</div>

			<label class="fractal-slider-label">
				<span class="fractal-label-text">Iterations</span>
				<input
					class="fractal-slider"
					id="fractal-iter-slider"
					type="range"
					min="50"
					max="2000"
					step="10"
					value="200"
				/>
				<span class="fractal-iter-value" id="fractal-iter-value">200</span>
			</label>

			<div class="fractal-group">
				<label class="fractal-label-text" for="fractal-palette-select">Palette</label>
				<select class="fractal-select" id="fractal-palette-select">
					<!-- Options injected by script -->
				</select>
			</div>

			<button
				class="fractal-btn fractal-btn--reset"
				id="fractal-btn-reset"
				type="button"
			>Reset</button>
		</div>

		<div class="fractal-coords" id="fractal-coords">
			<span id="fractal-coord-text">center: -0.5 + 0i | zoom: 3.5x</span>
		</div>
	</div>

	<div class="fractal-hint" id="fractal-hint">
		Scroll to zoom. Drag to pan. Click to pick Julia seed.
	</div>
</div>

<style>
	.fractal-root {
		position: relative;
		width: 100%;
		height: 100%;
		overflow: hidden;
		background: var(--color-bg);
		container-type: inline-size;
	}

	.fractal-canvas {
		display: block;
		width: 100%;
		height: 100%;
		cursor: crosshair;
		touch-action: none;
	}

	/* ---- Floating controls bar ---- */

	.fractal-controls {
		position: fixed;
		bottom: var(--space-6);
		left: 50%;
		transform: translateX(-50%);
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: var(--space-2);
		padding: var(--space-3) var(--space-4);
		background: color-mix(in srgb, var(--color-bg) 85%, transparent);
		backdrop-filter: blur(var(--space-3));
		-webkit-backdrop-filter: blur(var(--space-3));
		border: var(--ui-border);
		border-radius: var(--radius-xl);
		box-shadow: var(--shadow-md);
		z-index: var(--z-float);
		max-width: calc(100% - var(--space-8));
		transition:
			background var(--duration-normal) var(--ease-out),
			border-color var(--duration-normal) var(--ease-out),
			box-shadow var(--duration-normal) var(--ease-out);
	}

	.fractal-controls-row {
		display: flex;
		align-items: center;
		gap: var(--space-3);
		flex-wrap: wrap;
		justify-content: center;
	}

	/* ---- Buttons ---- */

	.fractal-btn {
		font-family: var(--font-mono-brand);
		font-size: var(--font-size-xxs);
		letter-spacing: var(--letter-spacing-loose);
		padding: var(--space-1) var(--space-3);
		border: var(--ui-border);
		border-radius: var(--radius-md);
		background: transparent;
		color: var(--color-text-secondary);
		cursor: pointer;
		transition:
			color var(--duration-in) var(--ease-out),
			background var(--duration-in) var(--ease-out),
			border-color var(--duration-in) var(--ease-out);
	}

	.fractal-btn:hover {
		color: var(--color-primary);
		border-color: var(--color-primary);
	}

	.fractal-btn--active {
		background: var(--color-surface);
		color: var(--color-text);
		border-color: var(--color-border-strong);
	}

	.fractal-btn--reset {
		color: var(--color-muted);
	}

	.fractal-btn--reset:hover {
		color: var(--color-primary);
		border-color: var(--color-primary);
	}

	/* ---- Slider ---- */

	.fractal-slider-label {
		display: flex;
		align-items: center;
		gap: var(--space-2);
	}

	.fractal-label-text {
		font-family: var(--font-mono-brand);
		font-size: var(--font-size-xxs);
		letter-spacing: var(--letter-spacing-loose);
		color: var(--color-text-secondary);
	}

	.fractal-slider {
		width: var(--space-24);
		accent-color: var(--color-primary);
		cursor: pointer;
	}

	.fractal-iter-value {
		font-family: var(--font-mono-brand);
		font-size: var(--font-size-xxs);
		color: var(--color-text-muted);
		min-width: var(--space-10);
		text-align: right;
	}

	/* ---- Select ---- */

	.fractal-select {
		font-family: var(--font-mono-brand);
		font-size: var(--font-size-xxs);
		letter-spacing: var(--letter-spacing-loose);
		padding: var(--space-1) var(--space-2);
		border: var(--ui-border);
		border-radius: var(--radius-md);
		background: var(--color-surface);
		color: var(--color-text-secondary);
		cursor: pointer;
		transition:
			border-color var(--duration-in) var(--ease-out),
			color var(--duration-in) var(--ease-out);
	}

	.fractal-select:hover,
	.fractal-select:focus-visible {
		border-color: var(--color-primary);
		color: var(--color-text);
		outline: none;
	}

	/* ---- Coordinates ---- */

	.fractal-coords {
		font-family: var(--font-mono-brand);
		font-size: var(--font-size-label);
		letter-spacing: var(--letter-spacing-loose);
		color: var(--color-text-muted);
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
		max-width: 100%;
	}

	/* ---- Groups ---- */

	.fractal-group {
		display: flex;
		align-items: center;
		gap: var(--space-2);
	}

	/* ---- Hint toast ---- */

	.fractal-hint {
		position: fixed;
		top: calc(var(--space-12) + var(--space-4));
		left: 50%;
		transform: translateX(-50%);
		font-family: var(--font-mono-brand);
		font-size: var(--font-size-xxs);
		letter-spacing: var(--letter-spacing-loose);
		color: var(--color-text-muted);
		background: color-mix(in srgb, var(--color-bg) 85%, transparent);
		backdrop-filter: blur(var(--space-3));
		-webkit-backdrop-filter: blur(var(--space-3));
		border: var(--ui-border);
		border-radius: var(--radius-lg);
		padding: var(--space-2) var(--space-4);
		opacity: 1;
		transition: opacity 0.6s var(--ease-out);
		z-index: var(--z-float);
		pointer-events: none;
	}

	.fractal-hint--hidden {
		opacity: 0;
	}

	/* ---- Mobile ---- */

	@media (max-width: 600px) {
		/* @breakpoint-mobile */
		.fractal-controls {
			bottom: var(--space-4);
			padding: var(--space-2) var(--space-3);
			gap: var(--space-1);
		}

		.fractal-controls-row {
			gap: var(--space-2);
		}

		.fractal-slider {
			width: var(--space-16);
		}

		.fractal-coords {
			font-size: var(--font-size-label);
		}

		.fractal-hint {
			font-size: var(--font-size-label);
		}
	}
</style>

<script>
	import { onPageReady } from "../../../utils/lifecycle";
	import { type Palette, palettes } from "./palettes";
	import { FractalRenderer } from "./renderer";

	onPageReady((signal) => {
		const canvas = document.getElementById("fractal-canvas") as HTMLCanvasElement | null;
		if (!canvas) return;

		/* ---- Initialize renderer ---- */

		const renderer = new FractalRenderer(canvas);

		/* Detect initial theme */
		const currentTheme = document.documentElement.getAttribute("data-theme");
		renderer.theme = currentTheme === "dark" ? "dark" : "light";

		renderer.init();

		signal.addEventListener("abort", () => renderer.destroy());

		/* ---- DOM references ---- */

		const btnMandelbrot = document.getElementById("fractal-btn-mandelbrot");
		const btnJulia = document.getElementById("fractal-btn-julia");
		const iterSlider = document.getElementById("fractal-iter-slider") as HTMLInputElement | null;
		const iterValue = document.getElementById("fractal-iter-value");
		const paletteSelect = document.getElementById("fractal-palette-select") as HTMLSelectElement | null;
		const btnZoom = document.getElementById("fractal-btn-zoom");
		const btnReset = document.getElementById("fractal-btn-reset");
		const coordText = document.getElementById("fractal-coord-text");
		const hint = document.getElementById("fractal-hint");

		/* ---- Populate palette select ---- */

		if (paletteSelect) {
			for (const [i, pal] of palettes.entries()) {
				const opt = document.createElement("option");
				opt.value = String(i);
				opt.textContent = pal.name;
				paletteSelect.appendChild(opt);
			}
		}

		/* ---- Coordinate display ---- */

		function updateCoords(): void {
			if (!coordText) return;
			const { centerX, centerY, zoom } = renderer.viewport;
			const sign = centerY >= 0 ? "+" : "";
			const zoomLevel = (3.5 / zoom).toFixed(1);
			coordText.textContent = `center: ${centerX.toFixed(4)} ${sign}${centerY.toFixed(4)}i | zoom: ${zoomLevel}x`;
		}

		renderer.onViewportChange = () => updateCoords();
		updateCoords();

		/* ---- Hide hint after first interaction ---- */

		let hintVisible = true;
		function hideHint(): void {
			if (hintVisible && hint) {
				hint.classList.add("fractal-hint--hidden");
				hintVisible = false;
			}
		}

		/* ---- Fractal type toggle ---- */

		function setActiveButton(type: "mandelbrot" | "julia"): void {
			btnMandelbrot?.classList.toggle("fractal-btn--active", type === "mandelbrot");
			btnJulia?.classList.toggle("fractal-btn--active", type === "julia");
			btnMandelbrot?.setAttribute("aria-pressed", String(type === "mandelbrot"));
			btnJulia?.setAttribute("aria-pressed", String(type === "julia"));
		}

		btnMandelbrot?.addEventListener("click", () => {
			renderer.setFractalType("mandelbrot");
			setActiveButton("mandelbrot");
		}, { signal });

		btnJulia?.addEventListener("click", () => {
			renderer.setFractalType("julia");
			setActiveButton("julia");
		}, { signal });

		/* ---- Auto-zoom toggle ---- */

		function deactivateZoom(): void {
			if (renderer.isAutoZooming()) {
				renderer.stopAutoZoom();
			}
			btnZoom?.classList.remove("fractal-btn--active");
			btnZoom?.setAttribute("aria-pressed", "false");
		}

		btnZoom?.addEventListener("click", () => {
			if (renderer.isAutoZooming()) {
				deactivateZoom();
				renderer.requestRender();
			} else {
				renderer.startAutoZoom();
				btnZoom.classList.add("fractal-btn--active");
				btnZoom.setAttribute("aria-pressed", "true");
				setActiveButton("mandelbrot");
			}
		}, { signal });

		/* ---- Iteration slider ---- */

		iterSlider?.addEventListener("input", () => {
			const val = Number(iterSlider.value);
			renderer.setMaxIter(val);
			if (iterValue) iterValue.textContent = String(val);
		}, { signal });

		/* ---- Palette selector ---- */

		paletteSelect?.addEventListener("change", () => {
			const idx = Number(paletteSelect.value);
			const p = palettes[idx];
			if (p) renderer.setPalette(p);
		}, { signal });

		/* ---- Reset ---- */

		btnReset?.addEventListener("click", () => {
			renderer.reset();
			deactivateZoom();
			setActiveButton("mandelbrot");
			if (iterSlider) iterSlider.value = "200";
			if (iterValue) iterValue.textContent = "200";
			if (paletteSelect) paletteSelect.value = "0";
			renderer.setPalette(palettes[0] as Palette);
			updateCoords();
		}, { signal });

		/* ---- Mouse interaction: drag to pan ---- */

		let isDragging = false;
		let lastX = 0;
		let lastY = 0;
		let dragMoved = false;

		canvas.addEventListener("pointerdown", (e: PointerEvent) => {
			if (e.button !== 0) return;
			deactivateZoom();
			isDragging = true;
			dragMoved = false;
			lastX = e.clientX;
			lastY = e.clientY;
			canvas.setPointerCapture(e.pointerId);
			hideHint();
		}, { signal });

		canvas.addEventListener("pointermove", (e: PointerEvent) => {
			if (!isDragging) return;
			const dx = e.clientX - lastX;
			const dy = e.clientY - lastY;
			if (Math.abs(dx) > 2 || Math.abs(dy) > 2) dragMoved = true;
			renderer.pan(dx, dy);
			lastX = e.clientX;
			lastY = e.clientY;
		}, { signal });

		canvas.addEventListener("pointerup", (e: PointerEvent) => {
			if (!isDragging) return;
			isDragging = false;

			/* If the user clicked without dragging, pick Julia seed */
			if (!dragMoved && renderer.fractalType === "mandelbrot") {
				const [re, im] = renderer.canvasToComplex(e.clientX, e.clientY);
				renderer.setJuliaSeed(re, im);
				renderer.setFractalType("julia");
				setActiveButton("julia");
			}
		}, { signal });

		/* ---- Mouse wheel: zoom toward cursor ---- */

		canvas.addEventListener("wheel", (e: WheelEvent) => {
			e.preventDefault();
			deactivateZoom();
			hideHint();
			const factor = e.deltaY > 0 ? 1.15 : 1 / 1.15;
			renderer.zoomAt(e.clientX, e.clientY, factor);
		}, { signal, passive: false });

		/* ---- Touch: pinch to zoom ---- */

		let lastPinchDist = 0;

		canvas.addEventListener("touchstart", (e: TouchEvent) => {
			hideHint();
			const t0 = e.touches[0];
			const t1 = e.touches[1];
			if (e.touches.length === 2 && t0 && t1) {
				lastPinchDist = Math.hypot(
					t1.clientX - t0.clientX,
					t1.clientY - t0.clientY,
				);
			}
		}, { signal, passive: true });

		canvas.addEventListener("touchmove", (e: TouchEvent) => {
			const t0 = e.touches[0];
			const t1 = e.touches[1];
			if (e.touches.length === 2 && t0 && t1) {
				e.preventDefault();
				const dist = Math.hypot(
					t1.clientX - t0.clientX,
					t1.clientY - t0.clientY,
				);
				const cx = (t0.clientX + t1.clientX) / 2;
				const cy = (t0.clientY + t1.clientY) / 2;

				if (lastPinchDist > 0) {
					const factor = lastPinchDist / dist;
					renderer.zoomAt(cx, cy, factor);
				}

				lastPinchDist = dist;
			}
		}, { signal, passive: false });

		canvas.addEventListener("touchend", () => {
			lastPinchDist = 0;
		}, { signal, passive: true });

		/* ---- Keyboard shortcuts ---- */

		document.addEventListener("keydown", (e: KeyboardEvent) => {
			/* Don't capture when typing in inputs */
			if (e.target instanceof HTMLInputElement || e.target instanceof HTMLSelectElement) return;

			const PAN_STEP = 50;
			switch (e.key) {
				case "ArrowLeft":
					deactivateZoom();
					renderer.pan(PAN_STEP, 0);
					break;
				case "ArrowRight":
					deactivateZoom();
					renderer.pan(-PAN_STEP, 0);
					break;
				case "ArrowUp":
					deactivateZoom();
					renderer.pan(0, PAN_STEP);
					break;
				case "ArrowDown":
					deactivateZoom();
					renderer.pan(0, -PAN_STEP);
					break;
				case "+":
				case "=":
					deactivateZoom();
					renderer.zoomAt(
						canvas.getBoundingClientRect().width / 2,
						canvas.getBoundingClientRect().height / 2,
						1 / 1.3,
					);
					break;
				case "-":
					deactivateZoom();
					renderer.zoomAt(
						canvas.getBoundingClientRect().width / 2,
						canvas.getBoundingClientRect().height / 2,
						1.3,
					);
					break;
				case "r":
				case "R":
					btnReset?.click();
					break;
				case "m":
				case "M":
					deactivateZoom();
					renderer.setFractalType("mandelbrot");
					setActiveButton("mandelbrot");
					break;
				case "j":
				case "J":
					deactivateZoom();
					renderer.setFractalType("julia");
					setActiveButton("julia");
					break;
				case "z":
				case "Z":
					btnZoom?.click();
					break;
				default:
					return;
			}
			e.preventDefault();
			hideHint();
		}, { signal });

		/* ---- Resize observer ---- */

		const resizeObserver = new ResizeObserver(() => {
			renderer.resize();
			renderer.requestRender();
		});
		resizeObserver.observe(canvas);
		signal.addEventListener("abort", () => resizeObserver.disconnect());

		/* ---- Theme observer ---- */

		const themeObserver = new MutationObserver(() => {
			const theme = document.documentElement.getAttribute("data-theme");
			renderer.setTheme(theme === "dark" ? "dark" : "light");
		});
		themeObserver.observe(document.documentElement, {
			attributes: true,
			attributeFilter: ["data-theme"],
		});
		signal.addEventListener("abort", () => themeObserver.disconnect());
	});
</script>
