---
/**
 * BaseHead - Common metadata and critical head scripts
 */
import { ClientRouter } from "astro:transitions";
import FontPreload from "./FontPreload.astro";
import { buildCSP } from "../utils/csp";
import { THEME_COLORS } from "../config/theme";
import themeInitRaw from "./theme-init.inline.js?raw"; // CSP-hashed
import platformDetectRaw from "./platform-detect.inline.js?raw"; // CSP-hashed

const themeInit = themeInitRaw
  .replace("__THEME_LIGHT__", THEME_COLORS.light)
  .replace("__THEME_DARK__", THEME_COLORS.dark);

interface Props {
  title: string;
  description: string;
  image?: string;
}

const { title, description, image } = Astro.props;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const siteURL = Astro.site?.toString().replace(/\/$/, "") ?? "https://fpl0.io";

const ogImage = image
  ? image.startsWith("http")
    ? image
    : `${siteURL}${image.startsWith("/") ? "" : "/"}${image}`
  : `${siteURL}/og-default.png`;

const twitterCardType = image ? "summary_large_image" : "summary";
---

<!-- Theme color (browser chrome) — must precede theme-init so the script can override -->
<meta name="theme-color" content={THEME_COLORS.light} media="(prefers-color-scheme: light)" />
<meta name="theme-color" content={THEME_COLORS.dark} media="(prefers-color-scheme: dark)" />

<!-- Theme init - runs before paint to prevent flash -->
<script is:inline set:html={themeInit} />
<!-- Platform detection — sets data-platform="other" on non-Mac for kbd hints -->
<script is:inline set:html={platformDetectRaw} />

<FontPreload />
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- CSP -->
<meta
  http-equiv="Content-Security-Policy"
  content={buildCSP()}
/>
<meta name="generator" content={Astro.generator} />

<!-- SEO -->
<title>{title === "fpl0" ? "fpl0" : title.endsWith(" | fpl0") ? title : `${title} | fpl0`}</title>
<meta name="description" content={description} />
<link rel="canonical" href={canonicalURL} />
<meta name="author" content="Filipe Lima" />

<!-- Open Graph -->
<meta property="og:type" content="website" />
<meta property="og:url" content={canonicalURL} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:site_name" content="fpl0" />
<meta property="og:image" content={ogImage} />

<!-- Twitter -->
<meta name="twitter:card" content={twitterCardType} />
<meta name="twitter:title" content={title} />
<meta name="twitter:description" content={description} />
<meta name="twitter:image" content={ogImage} />

<!-- Icons -->
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
<link rel="manifest" href="/site.webmanifest" />
<link rel="icon" href="/favicon.ico" />

<!-- RSS Feed -->
<link
  rel="alternate"
  type="application/rss+xml"
  title="fpl0 RSS Feed"
  href="/rss.xml"
/>

<!-- View Transitions -->
<ClientRouter />
